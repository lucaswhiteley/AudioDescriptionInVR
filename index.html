<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>12 AD three.js app</title>
    <style>
        body {
            margin: 0;
        }
    </style>
</head>

<body>
    <!--First import the code for three.js and FirstPersonController from file-->
    <script src="js/three.js"></script>
    <script src="js/FirstPersonControls.js"></script>
    <script type="module" src="js/VRButton.js"></script>



    <script >
        //import * as THREE from 'https://cdn.skypack.dev/three';


        //import { VRButton } from 'three/examples/jsm/webxr/VRButton.js';


        var renderer;
        var scene;
        var camera;

        //Camera location
        var cameraX;
        var cameraY;
        var cameraZ;

        //Array to store the Audiodescription Script
        var adScript = [];
        //The actual message that will be read out
        var adMessage;

        var clock = new THREE.Clock();

        class ThreeDObject {
            constructor(colour, shape, x, y, z, distance, angle) {
                this.colour = colour;
                this.shape = shape;
                this.x = x;
                this.y = y;
                this.z = z;
                this.theDistance = -1;
                this.theAngle = -1;

                //this.angle = -1;
            }
        }

        //var red = "0xff1100";
        //var green = "0x00ff59";
        //var purple = "0xff00e1";

        var threeDObjectArray = [];

        //initialises the scene
        itit();
        //populates the scene with objects
        populate();
        //animates the scene (primarily camera movement)
        animate();

        //defines the animation of the scene and calls the renderer.
        function animate() {
            //IN PROGRESS
            var delta = clock.getDelta();

            fpcCamera.movementSpeed = 101
            fpcCamera.update(delta);

            //TEST webxr
            //requestAnimationFrame(animate);
            renderer.setAnimationLoop(animate)
            renderer.xr.enabled = true;



            //Renders the scene
            renderer.render(scene, camera);
        }

        //Initialises the scene and other essential things before the program runs
        function itit() {


            //ititialises the renderer and sets it to the size of the window
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement)

            console.log("window.innerWidth = " + window.innerWidth);
            console.log("window.innerHeight = " + window.innerHeight);


            //Initialises the scene
            scene = new THREE.Scene();

            //Initialises the camera
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.set(40, 40, 400);
            camera.lookAt(100, 40, 400);
            scene.add(camera);

            cameraX = 0;


            //IN PROGRESS
            fpcCamera = new THREE.FirstPersonControls(camera, document.body);

            var gloorGeometry = new THREE.PlaneGeometry(window.innerWidth * 2, window.innerHeight * 2, 1, 1);
            var floorMaterial = new THREE.MeshBasicMaterial({ color: 0x00ffff });
            var floor = new THREE.Mesh(gloorGeometry, floorMaterial);
            //This line renders both sides of the plane
            floor.material.side = THREE.DoubleSide;
            floor.rotation.x = (-Math.PI / 2);
            floor.position.y = 0;
            floor.position.x = 0;
            floor.position.z = 0;

            scene.add(floor);

        }

        //populates the scene with all of the objects
        function populate() {
            //Arrays to store the positions of the objects
            var objectsX = [];
            var objectsZ = [];
            //Create a loop to create a random number of cubes, spheres and cones

            var numToGen = Math.floor(Math.random() * 5) + 2;
            //test
            //var numToGen = 1;

            //generates between 2 and 5 cubes
            for (let i = 0; i < numToGen; i++) {


                ///Choosing the shape of the object
                let z = Math.floor(Math.random() * 3) + 1;
                switch (z) {
                    case 1:
                        //Box
                        objectShape = "Box";
                        geometry = new THREE.BoxGeometry(100, 100, 100)
                        break;
                    case 2:
                        //Sphere
                        objectShape = "Sphere";
                        geometry = new THREE.SphereGeometry(60)
                        break;
                    case 3:
                        //Cone
                        objectShape = "Cone";

                        geometry = new THREE.ConeGeometry(50, 100)
                        break;
                }

                //choosing the colour of the object
                let x = Math.floor(Math.random() * 3) + 1;
                switch (x) {
                    case 1:
                        //red
                        objectColour = "red";
                        material = new THREE.MeshBasicMaterial({ color: 0xff1100 });
                        break;
                    case 2:
                        //Spring Green
                        objectColour = "Spring Green";
                        material = new THREE.MeshBasicMaterial({ color: 0x00ff59 });
                        break;
                    case 3:
                        //Purple Pizzazz
                        objectColour = "Purple Pizzazz";
                        material = new THREE.MeshBasicMaterial({ color: 0xff00e1 });
                        break;
                }


                mesh = new THREE.Mesh(geometry, material)
                //since 0 is the middle of the plane, the position could be negative too
                mesh.position.x = Math.floor(Math.random() * 1850) - 900;
                mesh.position.y = 50;

                //loops through the x array to see if there are any overlaps
                for (let j = 0; j < objectsX.length; j++) {
                    console.log("objectsX.length: " + objectsX.length);

                    if (objectsX[j] - 200 <= mesh.position.x <= objectsX[j] + 200) {
                        mesh.position.x = Math.floor(Math.random() * 800) - 400;
                        //console.log("X OVERLAP, ORIG:" + objectsX[j] + "NEW: " + mesh.position.x)
                    }
                }

                //adds the x position of the object to the Array
                objectsX[i] = mesh.position.x;
                mesh.position.z = Math.floor(Math.random() * 810) - 405;

                //loops through the Z array to see if there are any overlaps
                for (let k = 0; k < objectsZ.length; k++) {
                    console.log(objectsZ.length);

                    if (objectsZ[k] - 200 <= mesh.position.z <= objectsZ[k] + 200) {
                        mesh.position.z = Math.floor(Math.random() * 800) - 400;
                        //console.log("Z OVERLAP, ORIG:" + objectsZ[k] + "NEW: " + mesh.position.z)
                    }

                }

                //adds the y position of the object to the Array
                objectsZ[i] = mesh.position.z;

                //debug
                console.log("ObjectsX: " + objectsX)
                console.log("ObjectsZ: " + objectsZ)

                //creating the object and adding to the array
                let newObject = new ThreeDObject(objectColour, objectShape, mesh.position.x, mesh.position.y, mesh.position.z);
                threeDObjectArray[i] = newObject;
                console.log(threeDObjectArray[i]);
                console.log(threeDObjectArray.length);

                scene.add(mesh);
            }

        }

        //Working on getting the location of the camera with a button press
        window.addEventListener("keydown", onKeyDown, false);

        function onKeyDown(e) {
            if (e.keyCode == "32") {

                console.log("Camera Vitals: ")

                console.log("Camera X Position = " + camera.position.x)
                console.log("Camera Y Position = " + camera.position.y)
                console.log("Camera Z Position = " + camera.position.z)
                console.log("Camera Quaternian X = " + camera.quaternion.x)
                // camera.quaternion.y Returns the rotation of the camera in rad
                console.log("Camera Quaternian Y = " + camera.quaternion.y)

                //broken
                //var deg = convertRadDeg(camera.quaternion.y)
                //console.log("Camera Quaternian Y in Degrees = " + deg)


                console.log("Camera Quaternian Z = " + camera.quaternion.z)
                console.log("Camera Quaternian W = " + camera.quaternion.w)

                //Quaternion rotation in degrees
                console.log("Camera Quaternian Y in Degrees = " + camera.quaternion.y * (180 / Math.PI))
                console.log("Camera Quaternian W in Degrees = " + camera.quaternion.w * (180 / Math.PI))

                console.log("Camera FOV = " + camera.fov)

                theDistances = workOutDistance();
                console.log("Distances = " + theDistances)
                objectArrayToString();

                theAngles = workOutAngles();
                console.log("Object 1 Angle = " + threeDObjectArray[0].theAngle * (180 / Math.PI))

                //CALLS for the creation of the Audio Description
                createAD()
                console.log(adScript)
                //turns it into a message 
                adMessage = "";
                adScriptToMessage()
                console.log("Message: " + adMessage)

                //reads the messasge outloud
                readAD()

                //Debug information for the "undefined" bug
                for (let c = 0; c < adScript.length; c++) {
                    if (adScript[c].includes(undefined)) {
                        console.log("Undefined Name: " + adScript[c]);
                        console.log("Undefined Shape?: " + threeDObjectArray[c].shape);
                        console.log("Undefined Colour?: " + threeDObjectArray[c].color);
                        console.log("Undefined x?: " + threeDObjectArray[c].x);
                        console.log("Undefined y?: " + threeDObjectArray[c].y);
                        console.log("Undefined z?: " + threeDObjectArray[c].z);
                        console.log("Undefined Angle?: " + threeDObjectArray[c].theAngle);
                        console.log("Undefined Distance?: " + threeDObjectArray[c].theDistance);
                    }
                }

            }

        }

        //Converts the 3d object array into strings
        function objectArrayToString() {
            for (let a = 0; a < threeDObjectArray.length; a++) {

                console.log("Colour: " + threeDObjectArray[a].colour + " & Shape: " + threeDObjectArray[a].shape)

            }
        }

        //creates an array of the distances of objects to the camera
        function workOutDistance() {
            let distances = [];
            for (let a = 0; a < threeDObjectArray.length; a++) {
                //distances[a] = distance(threeDObjectArray[a].x, threeDObjectArray[a]. y,threeDObjectArray[a].z);
                distances[a] = distanceWithoutY(threeDObjectArray[a].x, threeDObjectArray[a].z);
                threeDObjectArray[a].theDistance = distances[a];
            }

            return distances;
        }

        //calculates the distance between an object and the camera using the X,and Z coordinates as Y is the same between each

        function distanceWithoutY(x, z) {
            let distanceToCamera = Math.sqrt(Math.pow((x - camera.position.x), 2) + Math.pow((z - camera.position.z), 2));
            return distanceToCamera;

        }



        //calculates the distance between an object and the camera using the X,Y, AND Z coordinates
        function distance(x, y, z) {
            //finds the distance between an object and the camera using Pythagoras theorem
            let distanceToCamera = Math.sqrt(Math.pow((camera.position.x - x), 2) + Math.pow((camera.position.y - y), 2) + Math.pow((camera.position.z - z), 2));
            return distanceToCamera;
        }


        //NOT COMPLETE

        //creates an array of the angles of objects to the camera
        function workOutAngles() {
            let angles = [];
            for (let a = 0; a < threeDObjectArray.length; a++) {
                angles[a] = getAngle(threeDObjectArray[a].x, threeDObjectArray[a].z);
                threeDObjectArray[a].theAngle = angles[a];
            }
            return angles;
        }

        //works out the angle of an object and the camera
        //does not take into account the rotation of the camera!!!
        function getAngle(x, z) {
            //formula for angle between = atan2
            angleToCamera = Math.atan2(camera.position.x - x, camera.position.z - z);
            return angleToCamera
        }

        //

        //function to work out the direction the camera is facing
        //currently does not work
        function getCameraDirection() {

            vector = camera.quaternion
            return vector
        }

        //converts Radians to degrees
        function convertRadDeg(rad) {
            var pi = Math.pi
            deg = rad * (180 / pi)
            return deg
        }

        //generates a random integer
        function randomInt(max) {
            return Math.floor(Math.random() * max + 1);
        }

        //Creates the array of Audio Desctiption
        function createAD() {

            //Clears the previous AD
            adScript.length = 0;

            //loops through the array and creates a line for each part.
            for (let b = 0; b < threeDObjectArray.length; b++) {
                if (threeDObjectArray[b].theDistance <= 200) {
                    a = randomInt(3);
                    if (a == 1) {
                        adScript[b] = "Very close up there is a ";
                    } else if (a == 2) {
                        adScript[b] = "Within reach there is a ";
                    } else if (a == 3) {
                        adScript[b] = "Directly in front of you there is a ";
                    }

                } else if (threeDObjectArray[b].theDistance <= 600) {
                    c = randomInt(2);
                    if (c == 1) {
                        adScript[b] = "At a medium distance there is a ";
                    } else if (c == 2) {
                        adScript[b] = "Not too far away there is a ";
                    }

                    //} else if (threeDObjectArray[b].theDistance < 950) {
                    //adScript[b] = "In the far distance, you can see a ";
                } else {
                    e = randomInt(2);
                    if (e == 1) {
                        adScript[b] = "In the distance, You can faintly see a ";
                    } else if (e == 2) {
                        adScript[b] = "Beyond the horizon there is a ";

                    }
                }

                //Loops through and adds the Colour
                switch (threeDObjectArray[b].colour) {
                    case "red":
                        adScript[b] += "red"
                        break;
                    case "Spring Green":
                        adScript[b] += "green"
                        break;
                    case "Purple Pizzazz":
                        adScript[b] += "purple"
                        break;
                    default:
                        adScript[b] += ""
                        break;
                }


                //Loops through and adds the shape
                switch (threeDObjectArray[b].shape) {
                    case "Box":
                        adScript[b] += " Box."
                        break;
                    case "Sphere":
                        adScript[b] += " Sphere."
                        break;
                    case "Cone":
                        adScript[b] += " Cone."
                        break;
                    default:
                        adScript[b] += ""
                        break;
                }
            }

            return adScript
        }

        //Converts the array to a string
        function adScriptToMessage() {
            for (let c = 0; c < adScript.length; c++) {
                adMessage += adScript[c];
                adMessage += " ";
            }
        }

        //reads out the Audio Description
        function readAD() {
            let utterance = new SpeechSynthesisUtterance();
            utterance.text = adMessage;
            window.speechSynthesis.speak(utterance);
        }

        //Code necessery for WebXR
        function setupVR()
        {
            //this.renderer.xr.enabled = true;
            document.body.appendChild(VRButton.createButton(this.renderer));
        }

    </script>
</body>

</html>